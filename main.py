import streamlit as st
import pandas as pd
import numpy as np

# --- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ---

# ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Å‡∏•
G_CONSTANT = 9.81    # (g) ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡πÇ‡∏ô‡πâ‡∏°‡∏ñ‡πà‡∏ß‡∏á (‡πÄ‡∏°‡∏ï‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ^2)
Z_BED = 1.497        # (z) ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≠‡∏á‡∏£‡πà‡∏≠‡∏á (‡πÄ‡∏°‡∏ï‡∏£)
DELTA_X = 500.0      # (Œîx) ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á (‡πÄ‡∏°‡∏ï‡∏£)
NUM_STEPS = 14       # (n) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏ß‡∏á (7000 ‡∏°. / 500 ‡∏°.)

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1 (‡∏´‡∏ô‡πâ‡∏≤ -12-)
RAW_DATA_TABLE_1 = {
    2564: {
        'S_0': 0.02253, 'n': 0.04, 'Q': 255.542, 'A': 1295.25, 'R': 8.659, 'v': 0.197, 'y_0': 0.3
    },
    2565: {
        'S_0': 0.02317, 'n': 0.04, 'Q': 481.249, 'A': 1278.75, 'R': 8.548, 'v': 0.371, 'y_0': 0.3
    },
    2566: {
        'S_0': 0.01977, 'n': 0.04, 'Q': 181.603, 'A': 1359.66, 'R': 9.089, 'v': 0.140, 'y_0': 0.3
    },
    2567: {
        'S_0': 0.02107, 'n': 0.04, 'Q': 258.136, 'A': 1317.50, 'R': 8.807, 'v': 0.199, 'y_0': 0.3
    }
}

# ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ô) ‡∏à‡∏≤‡∏Å ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 2 (‡∏´‡∏ô‡πâ‡∏≤ -13-)
# ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤ dy/dx ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
PAPER_DY_DX_TABLE_2 = {
    2564: {'dy_dx': 3.50252e-4},
    2565: {'dy_dx': 1.29659e-5},
    2566: {'dy_dx': 1.50482e-5},
    2567: {'dy_dx': 3.37711e-4}
}

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) ---

def calculate_Sf(n, Q, A, R):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì S_f ‡∏ï‡∏≤‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤ -12-"""
    if A == 0 or R == 0:
        return 0
    # S_f = (nQ / (A * R^(2/3)))^2
    term = (n * Q) / (A * (R**(2/3)))
    return term**2

def calculate_Fr(v, g, y_0):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Fr ‡∏ï‡∏≤‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤ -12-"""
    if g == 0 or y_0 == 0:
        return 0
    # Fr = v / sqrt(g * y_0)
    return v / np.sqrt(g * y_0)

def calculate_dy_dx(S_0, S_f, Fr):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì dy/dx ‡∏ï‡∏≤‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤ -11-"""
    if (1 - Fr**2) == 0:
        return 0
    # dy/dx = (S_0 - S_f) / (1 - Fr^2)
    return (S_0 - S_f) / (1 - Fr**2)

def run_simulation(dy_dx, y_initial, z_bed, delta_x, num_steps):
    """
    ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ç‡∏≠‡∏á Euler ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (W)
    (‡∏™‡∏°‡∏Å‡∏≤‡∏£ 2.4.3 ‡πÅ‡∏•‡∏∞ 2.5)
    """
    y_depths = [y_initial]
    W_levels = [y_initial + z_bed]
    y_current = y_initial
    
    for i in range(1, num_steps + 1):
        # ‡∏™‡∏°‡∏Å‡∏≤‡∏£ Euler's method (y_i = y_{i-1} + (dy/dx) * Œîx)
        y_next = y_current + (dy_dx * delta_x)
        
        # ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (W_n = y_n + z)
        W_next = y_next + z_bed
        
        y_depths.append(y_next)
        W_levels.append(W_next)
        y_current = y_next
        
    return y_depths, W_levels

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á Streamlit ---

st.set_page_config(page_title="‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î)", layout="wide")
st.title("üåä ‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°")
st.write("‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏™‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1) ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏î‡∏¥‡∏°")

# --- 4. Input Panel (‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á) ---

st.sidebar.header("‚öôÔ∏è 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô")

# 4.1 ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
selected_year = st.sidebar.selectbox(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1)",
    (2564, 2565, 2566, 2567)
)
raw_data = RAW_DATA_TABLE_1[selected_year]

with st.sidebar.expander(f"‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏õ‡∏µ {selected_year}"):
    st.json(raw_data)

# 4.2 ‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á (‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)
st.sidebar.header("‚öôÔ∏è 2. ‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á")
riverbank_level = st.sidebar.number_input(
    "**‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á (Riverbank Level) (‡πÄ‡∏°‡∏ï‡∏£)**",
    value=2.0,  # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏°‡∏°‡∏ï‡∏¥
    min_value=0.0,
    format="%.3f",
    help="‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 3.2)"
)

# 4.3 (Optional) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
with st.sidebar.expander("‡πÅ‡∏™‡∏î‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á"):
    g = st.number_input("‡∏Ñ‡πà‡∏≤ G (‡πÄ‡∏°‡∏ï‡∏£/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ^2)", value=G_CONSTANT, format="%.3f")
    z = st.number_input("‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≠‡∏á‡∏£‡πà‡∏≠‡∏á (z) (‡πÄ‡∏°‡∏ï‡∏£)", value=Z_BED, format="%.3f")
    dx = st.number_input("‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á (Œîx) (‡πÄ‡∏°‡∏ï‡∏£)", value=DELTA_X)
    n = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏ß‡∏á (n)", value=NUM_STEPS)
    y_0 = st.number_input("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (y‚ÇÄ) (‡πÄ‡∏°‡∏ï‡∏£)", value=raw_data['y_0'], format="%.3f")


# --- 5. Calculation Panel (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å) ---

st.header(f"üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ {selected_year}")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Tabs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
tab1 = st.tabs([
    "‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", 
])

# --- ‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î ---
# with tab1:
st.subheader("‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1)")
st.markdown("---")

# 1.1 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á (Sf, Fr, dy/dx) ‡∏™‡∏î
st.markdown("#### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á ($S_f$, $Fr$, $\\frac{{dy}}{{dx}}$)")
S_f_live = calculate_Sf(raw_data['n'], raw_data['Q'], raw_data['A'], raw_data['R'])
Fr_live = calculate_Fr(raw_data['v'], g, y_0) # <-- ‡πÉ‡∏ä‡πâ y_0 ‡∏à‡∏≤‡∏Å sidebar
dy_dx_live = calculate_dy_dx(raw_data['S_0'], S_f_live, Fr_live)

c1, c2, c3 = st.columns(3)

with c1:
    st.subheader("$S_f$ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô‡∏Ø)")
    st.latex(r"S_f = \left( \frac{n \times Q}{A \times R^{2/3}} \right)^2")
    
    # FIX: ‡πÉ‡∏ä‡πâ st.latex ‡πÅ‡∏•‡∏∞ .format() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á SyntaxError
    sf_latex_template = r"S_f = \left( \frac{{ {n_val} \times {q_val} }}{{ {a_val} \times {r_val:.3f}^{{{{2/3}}}} }} \right)^2"
    st.latex(sf_latex_template.format(
        n_val=raw_data['n'],
        q_val=raw_data['Q'],
        a_val=raw_data['A'],
        r_val=raw_data['R']
    ))
    st.metric("‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå $S_f$ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î)", f"{S_f_live:e}")

with c2:
    st.subheader("$Fr$ (Froude Number)")
    st.latex(r"Fr = \frac{v}{\sqrt{g \times y_0}}")
    
    # FIX: (‡∏ï‡πâ‡∏ô‡∏ï‡∏≠‡∏Ç‡∏≠‡∏á SyntaxError) ‡πÉ‡∏ä‡πâ st.latex ‡πÅ‡∏•‡∏∞ .format()
    fr_latex_template = r"Fr = \frac{{ {v_val} }}{{\sqrt{{ {g_val} \times {y_val} }}}}"
    st.latex(fr_latex_template.format(
        v_val=raw_data['v'],
        g_val=g,
        y_val=y_0
    ))
    st.metric("‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå $Fr$ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î)", f"{Fr_live:.6f}")

with c3:
    st.subheader("$\\frac{{dy}}{{dx}}$ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô‡∏ú‡∏¥‡∏ß‡∏ô‡πâ‡∏≥)")
    st.latex(r"\frac{dy}{dx} = \frac{S_0 - S_f}{1 - Fr^2}")
    
    # FIX: ‡πÉ‡∏ä‡πâ st.latex ‡πÅ‡∏•‡∏∞ .format() - double braces for dy and dx
    dydx_latex_template = r"\frac{{dy}}{{dx}} = \frac{{ {s0_val} - {sf_val:.2e} }}{{ 1 - {fr_val:.6f}^2 }}"
    st.latex(dydx_latex_template.format(
        s0_val=raw_data['S_0'],
        sf_val=S_f_live,
        fr_val=Fr_live
    ))
    st.metric("‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå $\\frac{{dy}}{{dx}}$ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î)", f"{dy_dx_live:.8f}")


# 1.2 ‡∏£‡∏±‡∏ô Euler's method ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ dy/dx ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î
st.markdown("---")
st.markdown("#### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.2: ‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á Euler ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ $\\frac{{dy}}{{dx}}$ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î")
y_depths_live, W_levels_live = run_simulation(dy_dx_live, y_0, z, dx, n)
W_average_live = np.mean(W_levels_live[1:])

# 1.3 ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
st.markdown("#### üéØ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.3: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î)")
c1, c2 = st.columns(2)
c1.metric(
    label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ (WÃÑ)",
    value=f"{W_average_live:.4f} ‡πÄ‡∏°‡∏ï‡∏£",
    help="‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á W‚ÇÅ ‡∏ñ‡∏∂‡∏á W‚ÇÅ‚ÇÑ (‡∏ï‡∏≤‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£ 2.6)"
)
c2.metric(
    label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô)",
    value=f"{riverbank_level:.4f} ‡πÄ‡∏°‡∏ï‡∏£",
    help="‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö"
)

if W_average_live > riverbank_level:
    st.error(f"**üö® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (FLOODING)**")
    st.write(f"‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ ({W_average_live:.4f} ‡∏°.) **‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤** ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á ({riverbank_level:.4f} ‡∏°.)")
else:
    st.success(f"**‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏õ‡∏Å‡∏ï‡∏¥ (NO FLOODING)**")

# 1.4 ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á
st.markdown("---")
st.subheader("‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏î)")
st.markdown("‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ ($W_i$) ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á ($i$) ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á")
chart_df_live = pd.DataFrame({
    '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ (W_i)': W_levels_live,
    '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏•‡∏¥‡πà‡∏á (Riverbank)': [riverbank_level] * (n + 1)
})
st.line_chart(chart_df_live.set_index(pd.Index(list(range(n + 1)), name="‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà (i)")))

st.markdown("#### ‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Euler's Method)")
# FIX: Escape braces properly in markdown
euler_exp_md = r"""
‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤:
- $\frac{{dy}}{{dx}} = {dydx_val:.8f}$
- $\Delta x = {dx_val}$ ‡πÄ‡∏°‡∏ï‡∏£
- $z = {z_val}$ ‡πÄ‡∏°‡∏ï‡∏£ (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≠‡∏á‡∏£‡πà‡∏≠‡∏á)
"""
st.markdown(euler_exp_md.format(
    dydx_val=dy_dx_live,
    dx_val=dx,
    z_val=z
))
st.latex(r"y_i = y_{i-1} + \left(\frac{dy}{dx}\right) \times \Delta x \quad \text{(‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö i = 1 ‡∏ñ‡∏∂‡∏á 14)}")
st.latex(r"W_i = y_i + z")


df_live = pd.DataFrame({
    "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà (i)": list(range(n + 1)),
    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (y_i) (‡πÄ‡∏°‡∏ï‡∏£)": y_depths_live,
    "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (W_i = y_i + z) (‡πÄ‡∏°‡∏ï‡∏£)": W_levels_live
})
st.dataframe(df_live.style.format("{:.4f}", subset=["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (y_i) (‡πÄ‡∏°‡∏ï‡∏£)", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (W_i = y_i + z) (‡πÄ‡∏°‡∏ï‡∏£)"]))